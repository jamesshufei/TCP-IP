<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCP/IP æ¨¡å‹äº’å‹•æ¨¡æ“¬</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- è¼‰å…¥ Babel ç”¨æ–¼è§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* åƒ…ä¿ç•™åŸºç¤è½‰å ´ï¼Œç§»é™¤æ‰€æœ‰ä½ç§»èˆ‡é–ƒçˆå‹•ç•« */
        body {
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- åœ–ç¤ºå…ƒä»¶ ---
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const ArrowDown = (props) => <IconBase {...props}><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></IconBase>;
        const ArrowUp = (props) => <IconBase {...props}><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const ArrowLeft = (props) => <IconBase {...props}><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></IconBase>;
        const Lock = (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const Unlock = (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>;
        const Server = (props) => <IconBase {...props}><rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/><line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/></IconBase>;
        const Laptop = (props) => <IconBase {...props}><path d="M20 16V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v9m16 0H4m16 0 1.28 2.55a1 1 0 0 1-.9 1.45H3.62a1 1 0 0 1-.9-1.45L4 16"/></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const Pause = (props) => <IconBase {...props}><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const ShieldCheck = (props) => <IconBase {...props}><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const StepForward = (props) => <IconBase {...props}><line x1="6" x2="6" y1="4" y2="20"/><polygon points="10 4 20 12 10 20 10 4"/></IconBase>;
        const Key = (props) => <IconBase {...props}><path d="m21 2-2 2m-7.6 7.6a6.5 6.5 0 1 1 2.2-2.3"/><circle cx="8" cy="16" r="3"/><path d="m14.5 9.5-2.5 2.5"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>;
        const Shield = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const PenTool = (props) => <IconBase {...props}><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const Hash = (props) => <IconBase {...props}><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></IconBase>;
        const Dice = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M16 8h.01"/><path d="M8 8h.01"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M12 12h.01"/></IconBase>;
        const Network = (props) => <IconBase {...props}><rect x="16" y="16" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3"/><path d="M12 12V8"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>;

        // --- ä¸»è¦æ‡‰ç”¨ç¨‹å¼é‚è¼¯ ---
        const TCPIPModel = () => {
            // ç‹€æ…‹ç®¡ç†
            const [isAutoPlay, setIsAutoPlay] = useState(false);
            const [stage, setStage] = useState('idle'); // idle, tcp_handshake, ssl_handshake, encapsulation, transmission, decapsulation, finished
            const [handshakeStep, setHandshakeStep] = useState(0); // 0-5 for SSL handshake
            const [tcpStep, setTcpStep] = useState(0); // 0-3 for TCP handshake
            const [currentLayer, setCurrentLayer] = useState(-1); // 0-4 (App to Physical)
            const [useSSL, setUseSSL] = useState(false);
            const [useTCP, setUseTCP] = useState(false);
            const [logMessages, setLogMessages] = useState([]);
            
            // å®šç¾©äº”å±¤æ¨¡å‹
            const layers = [
                { 
                id: 0, 
                name: 'æ‡‰ç”¨å±¤ (Application)', 
                desc: 'ç”¢ç”Ÿæ•¸æ“š (HTTP/SMTP)', 
                header: 'Data', 
                color: 'bg-red-100 border-red-500 text-red-700',
                pdu: 'Data' 
                },
                { 
                id: 1, 
                name: 'å‚³è¼¸å±¤ (Transport)', 
                desc: 'å»ºç«‹ç«¯å£é€£æ¥ (TCP/UDP)', 
                header: 'TCP Header', 
                color: 'bg-blue-100 border-blue-500 text-blue-700',
                pdu: 'Segment'
                },
                { 
                id: 2, 
                name: 'ç¶²è·¯å±¤ (Network)', 
                desc: 'IP å®šå€èˆ‡è·¯ç”±', 
                header: 'IP Header', 
                color: 'bg-green-100 border-green-500 text-green-700',
                pdu: 'Packet'
                },
                { 
                id: 3, 
                name: 'è³‡æ–™é€£çµå±¤ (Data Link)', 
                desc: 'MAC å¯¦é«”å®šå€', 
                header: 'Frame Header', 
                footer: 'FCS', 
                color: 'bg-yellow-100 border-yellow-500 text-yellow-700',
                pdu: 'Frame'
                },
                { 
                id: 4, 
                name: 'å¯¦é«”å±¤ (Physical)', 
                desc: 'ä½å…ƒæµå‚³è¼¸ (0/1)', 
                header: 'Preamble', 
                color: 'bg-gray-100 border-gray-500 text-gray-700',
                pdu: 'Bits'
                }
            ];

            // è¼”åŠ©å‡½å¼ï¼šæ–°å¢æ—¥èªŒ
            const addLog = (msg) => {
                setLogMessages(prev => [...prev, { time: new Date().toLocaleTimeString(), text: msg }]);
            };

            // åˆ¤æ–·æŸä¸€å±¤æ˜¯å¦æ­£åœ¨äº’å‹• (ç”¨æ–¼ Highlight)
            const isLayerActive = (layerId) => {
                if (stage === 'tcp_handshake' && layerId === 1) return true; // Transport Layer
                if (stage === 'ssl_handshake' && layerId === 0) return true; // Application Layer (SSL sits here/below)
                if (stage === 'encapsulation' && currentLayer === layerId) return true;
                if (stage === 'decapsulation' && currentLayer === layerId) return true;
                return false;
            };

            // åˆ¤æ–·æŸä¸€å±¤æ˜¯å¦æ‡‰è©²è®Šæš— (Dimmed)
            const isLayerDimmed = (layerId) => {
                if (stage === 'idle' || stage === 'finished') return false;
                // åœ¨æ¡æ‰‹éšæ®µï¼Œéäº’å‹•å±¤ç´šè®Šæš—
                if (stage === 'tcp_handshake' && layerId !== 1) return true;
                if (stage === 'ssl_handshake' && layerId !== 0) return true;
                // åœ¨å‚³è¼¸éšæ®µï¼Œéç•¶å‰å±¤ç´šä¸è®Šæš—(ä¿æŒå¯è¦‹)ï¼Œæˆ–å¯é¸æ“‡è®Šæš—
                return false;
            };

            // æ ¸å¿ƒé‚è¼¯ï¼šåŸ·è¡Œä¸‹ä¸€æ­¥
            const handleNextStep = () => {
                // 1. Idle -> Start Sequence
                if (stage === 'idle') {
                    setLogMessages([]);
                    if (useTCP) {
                        setStage('tcp_handshake');
                        setTcpStep(1);
                        addLog("TCP: é–‹å§‹å»ºç«‹å‚³è¼¸å±¤é€£ç·š (ä¸‰å‘äº¤æ¡)...");
                        addLog("TCP Handshake [1/3]: SYN (Client è«‹æ±‚é€£ç·š)");
                    } else if (useSSL) {
                        setStage('ssl_handshake');
                        setHandshakeStep(1);
                        addLog("SSL/TLS: åµæ¸¬åˆ°å®‰å…¨é€£ç·šéœ€æ±‚ï¼Œé–‹å§‹æ¡æ‰‹ç¨‹åº...");
                        addLog("Handshake [1/5]: Client Hello (ç™¼é€äº‚æ•¸ A (é¹½) èˆ‡åŠ å¯†å¥—ä»¶åˆ—è¡¨)");
                    } else {
                        setStage('encapsulation');
                        setCurrentLayer(0);
                        addLog("æ‡‰ç”¨å±¤: é–‹å§‹ç”¢ç”Ÿè³‡æ–™ (ç„¡åŠ å¯†)...");
                    }
                    return;
                }

                // 1.5 TCP Handshake Sequence
                if (stage === 'tcp_handshake') {
                    if (tcpStep === 1) {
                        setTcpStep(2);
                        addLog("TCP Handshake [2/3]: SYN-ACK (Server åŒæ„é€£ç·šä¸¦ç¢ºèª)");
                        return;
                    }
                    if (tcpStep === 2) {
                        setTcpStep(3);
                        addLog("TCP Handshake [3/3]: ACK (Client ç¢ºèªï¼Œé€£ç·šå»ºç«‹æˆåŠŸ)");
                        return;
                    }
                    if (tcpStep === 3) {
                        // TCP Finished, check for SSL or Data
                        setTcpStep(0);
                        if (useSSL) {
                            setStage('ssl_handshake');
                            setHandshakeStep(1);
                            addLog("SSL/TLS: TCP é€£ç·šå·²å»ºç«‹ï¼Œé–‹å§‹é€²è¡Œ TLS æ¡æ‰‹...");
                            addLog("Handshake [1/5]: Client Hello (ç™¼é€äº‚æ•¸ A (é¹½) èˆ‡åŠ å¯†å¥—ä»¶åˆ—è¡¨)");
                        } else {
                            setStage('encapsulation');
                            setCurrentLayer(0);
                            addLog("æ‡‰ç”¨å±¤: TCP é€£ç·šå·²å»ºç«‹ï¼Œé–‹å§‹ç”¢ç”Ÿè³‡æ–™...");
                        }
                        return;
                    }
                }

                // 2. SSL Handshake Sequence
                if (stage === 'ssl_handshake') {
                    if (handshakeStep === 1) {
                        setHandshakeStep(2);
                        addLog("Handshake [2/5]: Server Hello + Certificate (å‚³é€å…¬é‘° ğŸŸ¢ï¼Œäº‚æ•¸ B ğŸ²)");
                        return;
                    }
                    if (handshakeStep === 2) {
                        setHandshakeStep(3);
                        addLog("Handshake [3/5]: Digital Signature (éå°ç¨±é‡‘é‘°: Server ç”¨ç§é‘° ğŸ”´ ç°½ç½²ï¼ŒClient ç”¨å…¬é‘° ğŸŸ¢ é©—è­‰ï¼Œç¢ºèªä¼ºæœå™¨èº«åˆ†)");
                        return;
                    }
                    if (handshakeStep === 3) {
                        setHandshakeStep(4);
                        addLog("Handshake [4/5]: Client Key Exchange (Client ç”¨å…¬é‘° ğŸŸ¢ åŠ å¯†ã€Œé ä¸»å¯†é‘°ã€ï¼ŒServer ç”¨ç§é‘° ğŸ”´ è§£å¯†å–å¾—è©²å¯†é‘°)");
                        return;
                    }
                    if (handshakeStep === 4) {
                        setHandshakeStep(5);
                        addLog("Handshake [5/5]: Session Key Generation (ä½¿ç”¨ Hash / PRF æ··åˆé‹ç®—ç”Ÿæˆå°ç¨±é‡‘é‘° ğŸŸ¡)");
                        return;
                    }
                    if (handshakeStep === 5) {
                        setStage('encapsulation');
                        setCurrentLayer(0);
                        setHandshakeStep(0); // Reset for next time
                        addLog("æ‡‰ç”¨å±¤: å®‰å…¨é€šé“å»ºç«‹å®Œæˆï¼Œå¾ŒçºŒå‚³è¼¸å°‡ä½¿ç”¨å°ç¨±é‡‘é‘° ğŸŸ¡ é€²è¡ŒåŠ å¯†...");
                        return;
                    }
                }

                // 3. Encapsulation (Sender: 0 -> 4)
                if (stage === 'encapsulation') {
                    if (currentLayer < 4) {
                        const nextLayer = currentLayer + 1;
                        setCurrentLayer(nextLayer);
                        addLog(`ç™¼é€ç«¯ [${layers[nextLayer].name}]: åŠ ä¸Š ${layers[nextLayer].header}ï¼Œå°è£è³‡æ–™...`);
                    } else {
                        setStage('transmission');
                        addLog("å¯¦é«”å±¤: å°‡æ•¸ä½è¨Šè™Ÿè½‰æ›ç‚ºé›»å­è¨Šè™Ÿï¼Œé€šéç¶²éš›ç¶²è·¯å‚³è¼¸...");
                    }
                    return;
                }

                // 4. Transmission
                if (stage === 'transmission') {
                    setStage('decapsulation');
                    setCurrentLayer(4); // Receiver starts at 4
                    addLog("æ¥æ”¶ç«¯ [å¯¦é«”å±¤]: æ”¶åˆ°è¨Šè™Ÿï¼Œé‚„åŸç‚ºä½å…ƒæµ...");
                    return;
                }

                // 5. Decapsulation (Receiver: 4 -> 0)
                if (stage === 'decapsulation') {
                    if (currentLayer > 0) {
                        const nextLayer = currentLayer - 1;
                        setCurrentLayer(nextLayer);
                        addLog(`æ¥æ”¶ç«¯ [${layers[currentLayer].name}]: ç§»é™¤ ${layers[currentLayer].header}ï¼Œè®€å– ${layers[currentLayer].pdu}...`);
                    } else {
                        setStage('finished');
                        setIsAutoPlay(false);
                        const finalMsg = useSSL 
                            ? "æ‡‰ç”¨å±¤: ä½¿ç”¨å°ç¨±é‡‘é‘°è§£å¯†è³‡æ–™ã€‚å‚³è¼¸å®Œæˆï¼" 
                            : "æ‡‰ç”¨å±¤: è³‡æ–™å‚³è¼¸å®Œæˆï¼ç”¨æˆ¶æ”¶åˆ°è¨Šæ¯ã€‚";
                        addLog(finalMsg);
                    }
                    return;
                }
            };

            // è‡ªå‹•æ’­æ”¾æ§åˆ¶
            useEffect(() => {
                let timer;
                const delay = (stage === 'ssl_handshake' || stage === 'tcp_handshake') ? 3000 : 1500;
                
                if (isAutoPlay && stage !== 'finished') {
                    timer = setTimeout(() => {
                        handleNextStep();
                    }, delay); 
                }
                return () => clearTimeout(timer);
            }, [isAutoPlay, stage, currentLayer, handshakeStep, tcpStep]);

            // é–‹å§‹è‡ªå‹•æ’­æ”¾
            const startAutoPlay = () => {
                if (stage === 'finished') resetSimulation();
                setIsAutoPlay(true);
            };

            // æš«åœ
            const pauseSimulation = () => {
                setIsAutoPlay(false);
            };

            // é‡ç½®
            const resetSimulation = () => {
                setIsAutoPlay(false);
                setStage('idle');
                setCurrentLayer(-1);
                setHandshakeStep(0);
                setTcpStep(0);
                setLogMessages([]);
            };

            // åˆ¤æ–·ç™¼é€ç«¯å°åŒ…æ˜¯å¦é¡¯ç¤º
            const showSenderPacket = (layerId) => {
                if (stage === 'idle' || stage === 'ssl_handshake' || stage === 'tcp_handshake') return false;
                if (stage === 'encapsulation') return layerId <= currentLayer;
                return true; 
            };

            // åˆ¤æ–·æ¥æ”¶ç«¯å°åŒ…æ˜¯å¦é¡¯ç¤º
            const showReceiverPacket = (layerId) => {
                if (stage === 'idle' || stage === 'ssl_handshake' || stage === 'tcp_handshake' || stage === 'encapsulation' || stage === 'transmission') return false;
                if (stage === 'decapsulation') return layerId >= currentLayer;
                return true;
            };

            // æ¸²æŸ“å°åŒ…å…§å®¹
            const renderPacket = (layerIndex, isSender) => {
                if (layerIndex === 4) {
                return (
                    <div className="font-mono text-xs tracking-widest text-gray-600 break-all bg-gray-50 px-2 py-1 rounded border border-gray-200">
                    10110100...
                    </div>
                );
                }

                let headers = [];
                const maxLayer = layerIndex;

                if (maxLayer >= 3) headers.push(
                <div key="eth" className="px-2 py-1 bg-yellow-500 text-white text-xs font-bold border-r border-white/20">ETH</div>
                );
                
                if (maxLayer >= 2) headers.push(
                <div key="ip" className="px-2 py-1 bg-green-500 text-white text-xs font-bold border-r border-white/20">IP</div>
                );

                if (maxLayer >= 1) headers.push(
                <div key="tcp" className="px-2 py-1 bg-blue-500 text-white text-xs font-bold border-r border-white/20">TCP</div>
                );

                if (useSSL && maxLayer >= 0) headers.push(
                <div key="ssl" className="px-2 py-1 bg-purple-600 text-white text-xs font-bold border-r border-white/20 flex items-center">
                    <Lock size={10} className="mr-1" /> TLS
                </div>
                );

                const showEncrypted = useSSL && layerIndex > 0;
                
                headers.push(
                <div key="data" className={`px-3 py-1 text-xs font-bold flex items-center min-w-[60px] justify-center
                    ${showEncrypted ? 'bg-purple-100 text-purple-800' : 'bg-white text-gray-800'}`}>
                    {showEncrypted ? '***Encrypted***' : 'Hello World'}
                </div>
                );

                if (maxLayer >= 3) headers.push(
                <div key="fcs" className="px-2 py-1 bg-yellow-500 text-white text-xs font-bold border-l border-white/20">FCS</div>
                );

                return (
                <div className="flex shadow-md rounded overflow-hidden border border-gray-300 scale-90 origin-left transition-all duration-300">
                    {headers}
                </div>
                );
            };

            // æ¸²æŸ“æ¡æ‰‹éšæ®µ (SSL/TCP) çš„è¦–è¦ºåŒ–å…ƒä»¶
            const renderVisualOverlay = () => {
                // å¦‚æœä¸æ˜¯æ¡æ‰‹éšæ®µï¼Œä¸é¡¯ç¤º
                if (stage !== 'ssl_handshake' && stage !== 'tcp_handshake') return null;

                // --- TCP Handshake Visuals ---
                if (stage === 'tcp_handshake') {
                    return (
                        <div className="absolute inset-0 flex flex-col items-center justify-center z-20 bg-slate-50/95 backdrop-blur-sm rounded-lg p-2 border-2 border-blue-200">
                            <div className="text-blue-700 font-bold mb-2 text-lg pt-1">
                                TCP ä¸‰å‘äº¤æ¡ ({tcpStep}/3)
                                <span className="block text-xs font-normal text-slate-500 mt-1">äº’å‹•å±¤ç´šï¼šå‚³è¼¸å±¤ (Layer 4)</span>
                            </div>
                            
                            <div className="flex items-center justify-between w-full max-w-2xl mb-2 relative mt-4 h-32">
                                {/* Client */}
                                <div className="flex flex-col items-center w-28">
                                    <Laptop size={48} className="text-blue-600 mb-2" />
                                    <span className="text-sm font-bold text-gray-600">Client</span>
                                </div>

                                {/* TCP Animation Flow */}
                                <div className="flex-1 px-2 flex flex-col items-center justify-center z-10 relative">
                                    {tcpStep === 1 && (
                                        <div className="flex flex-col items-center w-full">
                                            <div className="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold border border-blue-300 shadow-sm flex items-center gap-2 mb-2 w-full justify-center">
                                                <span>SYN</span>
                                                <span className="text-[10px] text-gray-500">(Seq=x)</span>
                                            </div>
                                            <ArrowRight size={40} className="text-blue-400" />
                                        </div>
                                    )}
                                    {tcpStep === 2 && (
                                        <div className="flex flex-col items-center w-full">
                                            <div className="bg-green-100 text-green-700 px-4 py-2 rounded-lg font-bold border border-green-300 shadow-sm flex items-center gap-2 mb-2 w-full justify-center">
                                                <span>SYN-ACK</span>
                                                <span className="text-[10px] text-gray-500">(Seq=y, Ack=x+1)</span>
                                            </div>
                                            <ArrowLeft size={40} className="text-green-400" />
                                        </div>
                                    )}
                                    {tcpStep === 3 && (
                                        <div className="flex flex-col items-center w-full">
                                            <div className="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold border border-blue-300 shadow-sm flex items-center gap-2 mb-2 w-full justify-center">
                                                <span>ACK</span>
                                                <span className="text-[10px] text-gray-500">(Seq=x+1, Ack=y+1)</span>
                                            </div>
                                            <ArrowRight size={40} className="text-blue-400" />
                                        </div>
                                    )}
                                </div>

                                {/* Server */}
                                <div className="flex flex-col items-center w-28">
                                    <Server size={48} className="text-green-600 mb-2" />
                                    <span className="text-sm font-bold text-gray-500">Server</span>
                                </div>
                            </div>
                            <div className="text-sm text-gray-600 mt-4 font-medium bg-white px-4 py-2 rounded border border-gray-200">
                                {tcpStep === 1 ? "æ­¥é©Ÿ 1: å®¢æˆ¶ç«¯ç™¼é€ SYN è«‹æ±‚å»ºç«‹é€£ç·š" : 
                                 tcpStep === 2 ? "æ­¥é©Ÿ 2: ä¼ºæœå™¨å›è¦† SYN-ACK åŒæ„é€£ç·š" : 
                                 "æ­¥é©Ÿ 3: å®¢æˆ¶ç«¯ç™¼é€ ACK ç¢ºèªï¼Œé€£ç·šå·²å»ºç«‹"}
                            </div>
                        </div>
                    );
                }

                // --- SSL Handshake Visuals (Existing) ---
                const stepInfo = [
                    { title: "Client Hello", desc: "Clientç™¼é€æ”¯æ´çš„åŠ å¯†æ³• + äº‚æ•¸ A (é¹½)" },
                    { title: "Server Hello", desc: "ä¼ºæœå™¨å‚³é€æ†‘è­‰ (å…§å«å…¬é‘° ğŸŸ¢)ï¼Œç§é‘° ğŸ”´ ä¿ç•™åœ¨ä¼ºæœå™¨" },
                    { title: "Digital Signature", desc: "Server ç”¨ç§é‘° ğŸ”´ ç°½ç½² (è­‰æ˜èº«åˆ†)ï¼ŒClient ç”¨å…¬é‘° ğŸŸ¢ é©—è­‰ (æ•¸ä½ç°½ç« )" },
                    { title: "Key Exchange", desc: "Client ç”¨å…¬é‘° ğŸŸ¢ åŠ å¯†ã€Œé ä¸»å¯†é‘°ã€ï¼ŒServer ç”¨ç§é‘° ğŸ”´ è§£å¯†å–å¾—è©²å¯†é‘°" },
                    { title: "Session Key Gen", desc: "ä½¿ç”¨ Hash / PRF æ··åˆäº‚æ•¸èˆ‡å¯†é‘°ï¼Œç”Ÿæˆå°ç¨±é‡‘é‘° ğŸŸ¡" }
                ];

                const currentStepData = stepInfo[handshakeStep - 1];
                if (!currentStepData) return null;

                return (
                    <div className="absolute inset-0 flex flex-col items-center justify-center z-20 bg-slate-50/95 backdrop-blur-sm rounded-lg p-2 border-2 border-purple-200">
                        <div className="text-purple-700 font-bold mb-2 text-lg pt-1">
                            TLS æ¡æ‰‹éšæ®µ ({handshakeStep}/5)
                            <span className="block text-xs font-normal text-slate-500 mt-1">äº’å‹•å±¤ç´šï¼šæ‡‰ç”¨å±¤ (Layer 5)</span>
                        </div>
                        
                        <div className="flex items-center justify-between w-full max-w-2xl mb-2 relative mt-1">
                             {/* Client Icon Column */}
                             <div className="flex flex-col items-center w-28 relative">
                                <Laptop size={48} className="text-blue-600 mb-2" />
                                <span className="text-sm font-bold text-gray-600">Client</span>
                                
                                {/* Client æŒæœ‰ç‰© - éœæ…‹åˆ—è¡¨ */}
                                <div className="mt-2 flex flex-col gap-1 items-center w-full">
                                    {handshakeStep >= 2 && (
                                        <div className="flex items-center gap-1 text-[10px] text-green-700 bg-green-50 px-2 py-1 rounded border border-green-200 w-full justify-center">
                                            <Key size={10} /> <span>æŒæœ‰å…¬é‘°</span>
                                        </div>
                                    )}
                                    {handshakeStep === 3 && (
                                        <div className="flex items-center gap-1 text-[10px] text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-200 w-full justify-center">
                                            <CheckCircle size={10} /> <span>é©—è­‰æˆåŠŸ</span>
                                        </div>
                                    )}
                                </div>
                             </div>

                             {/* Middle: Animation Flow - ç§»é™¤æ‰€æœ‰å‹•ç•«ï¼Œæ”¹ç‚ºéœæ…‹å‘ˆç¾ */}
                             <div className="flex-1 px-2 flex flex-col items-center relative h-28 justify-center z-10">
                                
                                {/* Step 1: Client Hello */}
                                {handshakeStep === 1 && (
                                    <div className="flex flex-col items-center">
                                        <ArrowRight size={40} className="text-slate-400" />
                                        <div className="flex items-center gap-1 mt-1">
                                            <span className="text-xs font-bold text-slate-500">Client Hello</span>
                                        </div>
                                        <div className="flex items-center gap-1 bg-blue-50 border border-blue-200 px-2 py-1 rounded mt-1 text-[10px] text-blue-600">
                                            <Dice size={12} />
                                            <span>äº‚æ•¸ A</span>
                                        </div>
                                    </div>
                                )}

                                {/* Step 2: Server Hello (Static Arrow) */}
                                {handshakeStep === 2 && (
                                    <div className="flex flex-col items-center">
                                        <ArrowLeft size={40} className="text-green-500" />
                                        <div className="flex gap-1 mt-1">
                                            <div className="flex items-center gap-1 bg-white border border-green-200 px-2 py-1 rounded">
                                                <span className="text-xs font-bold text-green-600">å…¬é‘°</span>
                                                <Key size={12} className="text-green-600" />
                                            </div>
                                            <div className="flex items-center gap-1 bg-green-50 border border-green-200 px-2 py-1 rounded text-[10px] text-green-600">
                                                <Dice size={12} />
                                                <span>äº‚æ•¸ B</span>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Step 3: æ•¸ä½ç°½ç«  (é›™æ¬„ä½ - éœæ…‹) */}
                                {handshakeStep === 3 && (
                                    <div className="flex w-full justify-between items-center h-full gap-2">
                                        {/* Left: Client Verify */}
                                        <div className="flex flex-col items-center p-2 border border-green-200 rounded bg-green-50 shadow-sm w-24 bg-white">
                                             <div className="text-[10px] font-bold text-green-700 mb-1">Client é©—è­‰</div>
                                             <div className="flex items-center gap-1 mb-1">
                                                 <FileText size={14} className="text-blue-500" />
                                                 <span className="text-[10px] text-gray-400">+</span>
                                                 <Key size={12} className="text-green-500" />
                                             </div>
                                             <ArrowDown size={12} className="text-gray-400 my-0.5" />
                                             <CheckCircle size={14} className="text-green-600" />
                                        </div>

                                        {/* Center: Arrow */}
                                        <div className="flex flex-col items-center">
                                            <ArrowLeft size={32} className="text-blue-400" />
                                            <span className="text-[10px] text-blue-500 font-mono mt-1">å‚³é€ç°½ç« </span>
                                        </div>

                                        {/* Right: Server Sign */}
                                        <div className="flex flex-col items-center p-2 border border-blue-200 rounded bg-blue-50 shadow-sm w-24 bg-white">
                                             <div className="text-[10px] font-bold text-blue-700 mb-1">Server ç°½ç½²</div>
                                             <div className="flex items-center gap-1 mb-1">
                                                 <Key size={12} className="text-red-600" />
                                             </div>
                                             <ArrowDown size={12} className="text-gray-400 my-0.5" />
                                             <div className="flex items-center gap-1">
                                                 <PenTool size={12} className="text-blue-600" />
                                             </div>
                                        </div>
                                    </div>
                                )}

                                {/* Step 4: é‡‘é‘°äº¤æ› (é›™æ¬„ä½ - éœæ…‹) */}
                                {handshakeStep === 4 && (
                                    <div className="flex w-full justify-between items-center h-full gap-2">
                                        {/* Left: Encryption */}
                                        <div className="flex flex-col items-center p-2 border border-green-200 rounded bg-green-50 shadow-sm w-28 bg-white">
                                            <div className="text-[10px] font-bold text-green-700 mb-1">Client åŠ å¯†</div>
                                            <div className="flex items-center gap-1 mb-1">
                                                <div className="flex flex-col items-center">
                                                    <div className="w-3 h-3 bg-red-400 rounded-full border border-red-500"></div>
                                                    <span className="text-[8px] text-red-500 scale-90 whitespace-nowrap">é ä¸»å¯†é‘°</span>
                                                </div>
                                                <span className="text-[10px] text-gray-400">+</span>
                                                <div className="flex flex-col items-center">
                                                    <Key size={12} className="text-green-500" />
                                                    <span className="text-[8px] text-green-600 scale-90">å…¬é‘°</span>
                                                </div>
                                            </div>
                                            <ArrowDown size={12} className="text-gray-400 my-0.5" />
                                            <Lock size={14} className="text-purple-600" />
                                        </div>

                                        {/* Center: Arrow */}
                                        <div className="flex flex-col items-center">
                                            <ArrowRight size={32} className="text-purple-400" />
                                            <span className="text-[10px] text-purple-500 font-mono mt-1">å‚³è¼¸å¯†æ–‡</span>
                                        </div>

                                        {/* Right: Decryption */}
                                        <div className="flex flex-col items-center p-2 border border-red-200 rounded bg-red-50 shadow-sm w-28 bg-white">
                                            <div className="text-[10px] font-bold text-red-700 mb-1">Server è§£å¯†</div>
                                            <div className="flex items-center gap-1 mb-1">
                                                <Lock size={14} className="text-purple-600" />
                                                <span className="text-[10px] text-gray-400">+</span>
                                                <div className="flex flex-col items-center">
                                                    <Key size={12} className="text-red-600" />
                                                    <span className="text-[8px] text-red-600 scale-90">ç§é‘°</span>
                                                </div>
                                            </div>
                                            <ArrowDown size={12} className="text-gray-400 my-0.5" />
                                            <div className="flex flex-col items-center">
                                                <div className="w-3 h-3 bg-red-400 rounded-full border border-red-500"></div>
                                                <span className="text-[8px] text-red-500 scale-90 whitespace-nowrap">é ä¸»å¯†é‘°</span>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Step 5: Symmetric Key Gen */}
                                {handshakeStep === 5 && (
                                    <div className="flex flex-col items-center w-full">
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="text-xs bg-gray-100 px-1 rounded text-gray-500">äº‚æ•¸A</span>
                                            <span className="text-[10px] text-gray-400">+</span>
                                            <span className="text-xs bg-gray-100 px-1 rounded text-gray-500">äº‚æ•¸B</span>
                                            <span className="text-[10px] text-gray-400">+</span>
                                            <span className="text-xs bg-red-100 px-1 rounded text-red-500">é ä¸»å¯†é‘°</span>
                                        </div>
                                        
                                        <div className="flex items-center justify-center bg-blue-50 border border-blue-200 rounded px-3 py-1 mb-2 shadow-sm">
                                            <Hash size={16} className="text-blue-600 mr-1" />
                                            <span className="text-xs font-bold text-blue-700">Hash / PRF</span>
                                        </div>
                                        <ArrowDown size={16} className="text-gray-300 mb-1" />

                                        <div className="flex gap-16 w-full justify-center">
                                            <div className="text-yellow-500 flex flex-col items-center">
                                                <Key size={28} />
                                            </div>
                                            <div className="text-yellow-500 flex flex-col items-center">
                                                <Key size={28} />
                                            </div>
                                        </div>
                                    </div>
                                )}
                             </div>

                             {/* Server Icon Column */}
                             <div className="flex flex-col items-center w-28 relative">
                                <Server size={48} className="text-green-600 mb-2" />
                                <span className="text-sm font-bold text-gray-500">Server</span>
                                
                                {/* Server æŒæœ‰ç‰© - éœæ…‹åˆ—è¡¨ */}
                                <div className="mt-2 flex flex-col gap-1 items-center w-full">
                                    <div className="flex items-center gap-1 text-[10px] text-red-700 bg-red-50 px-2 py-1 rounded border border-red-200 w-full justify-center">
                                        <Key size={10} /> <span>æŒæœ‰ç§é‘°</span>
                                    </div>
                                </div>
                             </div>
                        </div>

                        <div className="text-sm text-gray-700 text-center bg-white p-3 rounded-lg shadow-sm border border-slate-200 w-full max-w-lg z-20 relative flex flex-col items-center">
                            <div className="font-bold text-purple-700 mb-1 border-b border-slate-100 pb-1">
                                {handshakeStep === 3 ? "æ•¸ä½ç°½ç« éšæ®µ (èº«åˆ†é©—è­‰)" : (handshakeStep === 2 || handshakeStep === 4 ? "éå°ç¨±åŠ å¯†éšæ®µ" : "å”å®šéšæ®µ")}
                            </div>
                            <div>
                                {currentStepData.desc}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                
                {/* æ¨™é¡Œå€ï¼šæ”¾å¯¬åˆ° 7xl */}
                <div className="max-w-[90%] md:max-w-7xl mx-auto mb-2 text-center">
                    <h1 className="text-2xl md:text-3xl font-bold text-slate-900 mb-2">
                    TCP/IP æ¨¡å‹å°åŒ…å°è£èˆ‡æ‹†è§£å±•ç¤º
                    </h1>
                    <p className="text-sm text-slate-600">
                    è§€å¯Ÿè³‡æ–™åœ¨æ¯ä¸€å±¤çš„è®ŠåŒ–ï¼Œä»¥åŠ SSL/TLS å¦‚ä½•é€éæ¡æ‰‹å»ºç«‹å®‰å…¨é€šé“ã€‚
                    </p>
                </div>

                {/* æ§åˆ¶é¢æ¿ï¼šæ”¾å¯¬åˆ° 7xl */}
                <div className="max-w-[90%] md:max-w-7xl mx-auto bg-white p-2 rounded-xl shadow-sm border border-slate-200 mb-2">
                    <div className="flex flex-wrap gap-4 items-center justify-between">
                    
                    <div className="flex items-center gap-2 flex-wrap">
                        {/* è‡ªå‹•æ’­æ”¾æŒ‰éˆ• */}
                        {!isAutoPlay ? (
                        <button 
                        onClick={startAutoPlay} 
                        disabled={stage === 'finished'}
                        className={`flex items-center gap-2 px-5 py-2 rounded-lg font-bold text-white transition-all
                            ${stage === 'finished' ? 'bg-slate-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 shadow-md'}`}
                        >
                        <Play size={18} />
                        è‡ªå‹•æ’­æ”¾
                        </button>
                        ) : (
                        <button 
                        onClick={pauseSimulation} 
                        className="flex items-center gap-2 px-5 py-2 rounded-lg font-bold text-white bg-amber-500 hover:bg-amber-600 shadow-md transition-all"
                        >
                        <Pause size={18} />
                        æš«åœ
                        </button>
                        )}

                        {/* é€æ­¥åŸ·è¡ŒæŒ‰éˆ• */}
                        <button 
                        onClick={() => { setIsAutoPlay(false); handleNextStep(); }}
                        disabled={stage === 'finished'}
                        className={`flex items-center gap-2 px-5 py-2 rounded-lg font-bold text-white transition-all
                            ${stage === 'finished' ? 'bg-slate-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 shadow-md'}`}
                        >
                        <StepForward size={18} />
                        é€æ­¥åŸ·è¡Œ
                        </button>

                        <button 
                        onClick={resetSimulation}
                        className="flex items-center gap-2 px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 text-slate-700 transition-all ml-2"
                        >
                        <RotateCcw size={18} />
                        é‡ç½®
                        </button>
                    </div>

                    <div className="flex items-center gap-4">
                        {/* TCP é–‹é—œ */}
                        <div 
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg border cursor-pointer transition-all select-none
                            ${useTCP ? 'bg-blue-50 border-blue-200' : 'bg-slate-100 border-slate-200'}`} 
                            onClick={() => {
                            if (stage === 'idle') setUseTCP(!useTCP);
                            }}
                        >
                            <div className={`w-5 h-5 rounded flex items-center justify-center transition-colors ${useTCP ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'}`}>
                            {useTCP ? <Network size={14} /> : null}
                            </div>
                            <span className={`text-sm font-medium ${useTCP ? 'text-blue-700' : 'text-slate-500'}`}>
                            å•Ÿç”¨ TCP ä¸‰å‘äº¤æ¡
                            </span>
                        </div>

                        {/* SSL é–‹é—œ */}
                        <div 
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg border cursor-pointer transition-all select-none
                            ${useSSL ? 'bg-purple-50 border-purple-200' : 'bg-slate-100 border-slate-200'}`} 
                            onClick={() => {
                            if (stage === 'idle') setUseSSL(!useSSL);
                            }}
                        >
                            <div className={`w-5 h-5 rounded flex items-center justify-center transition-colors ${useSSL ? 'bg-purple-600 text-white' : 'bg-gray-300 text-gray-500'}`}>
                            {useSSL ? <ShieldCheck size={14} /> : null}
                            </div>
                            <span className={`text-sm font-medium ${useSSL ? 'text-purple-700' : 'text-slate-500'}`}>
                            å•Ÿç”¨ SSL/TLS åŠ å¯†
                            </span>
                            {stage !== 'idle' && <span className="text-xs text-red-400 ml-1">(é‡ç½®å¾Œå¯æ›´æ”¹)</span>}
                        </div>
                    </div>
                    </div>
                </div>

                {/* ä¸»è¦è¦–è¦ºå€ï¼šå›ºå®šé«˜åº¦ h-[460px] æ­é… grid grid-rows-5 å‡åˆ† */}
                <div className="max-w-[90%] md:max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-10 gap-2 mb-2 relative h-[460px]">
                    
                    {/* å·¦å´ï¼šç™¼é€ç«¯ (Sender) */}
                    <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-2 relative overflow-hidden transition-all duration-700 ease-in-out flex flex-col
                        ${(stage === 'ssl_handshake' || stage === 'tcp_handshake') ? 'md:col-span-3' : 'md:col-span-4'}`}>
                        {/* Session Key Indicator (Sender) */}
                        {useSSL && stage !== 'idle' && stage !== 'handshake' && stage !== 'ssl_handshake' && stage !== 'tcp_handshake' && (
                            <div className="absolute top-2 right-2 bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1 border border-yellow-300 z-20">
                                <Key size={12} /> å°ç¨±é‡‘é‘°å·²å°±ç·’
                            </div>
                        )}

                        <div className="flex items-center gap-2 mb-2 pb-2 border-b border-slate-100 h-10 shrink-0">
                            <Laptop className="text-blue-600" />
                            <h2 className="font-bold text-lg">ç™¼é€ç«¯ (å°è£)</h2>
                        </div>
                        
                        <div className="flex-1 grid grid-rows-5 relative">
                            {layers.map((layer) => {
                                const isActive = isLayerActive(layer.id);
                                const isDimmed = isLayerDimmed(layer.id);
                                
                                return (
                                <div 
                                    key={`sender-${layer.id}`}
                                    className={`p-1 rounded-lg border transition-all duration-300 flex justify-between items-center relative
                                    ${layer.color} /* Always apply base color */
                                    ${isActive ? 'border-2 !border-slate-800 shadow-lg scale-[1.02] z-10' : 'border-opacity-50'}
                                    ${isDimmed ? 'opacity-20 grayscale' : ''}`}
                                >
                                    <div className="w-1/3">
                                        <div className="font-bold text-sm text-slate-700 truncate">{layer.name}</div>
                                        <div className="text-[10px] text-slate-500 leading-tight truncate">{layer.desc}</div>
                                    </div>
                                    
                                    {/* Active Badge - Moved INSIDE top right corner */}
                                    {isActive && (stage === 'tcp_handshake' || stage === 'ssl_handshake') && (
                                        <div className="absolute right-2 top-1 bg-yellow-500 text-white text-[10px] px-2 py-0.5 rounded-full shadow-sm flex items-center gap-1 z-20 animate-pulse">
                                            <Activity size={10} /> äº’å‹•ä¸­
                                        </div>
                                    )}
                                    
                                    {/* å°åŒ…å±•ç¤ºå€ */}
                                    <div className="flex-1 flex justify-end h-8">
                                    {showSenderPacket(layer.id) && (
                                        <div className="animate-fade-in-left">
                                        {renderPacket(layer.id, true)}
                                        </div>
                                    )}
                                    </div>
                                </div>
                            )})}
                            
                            {/* å‹•æ…‹ç®­é ­ - ä½¿ç”¨ç™¾åˆ†æ¯”å®šä½ */}
                            {stage === 'encapsulation' && (
                            <div className="absolute left-6 text-blue-500 z-10 transition-all duration-300" 
                                style={{ top: `${currentLayer * 20 + 10}%`, transform: 'translateY(-50%)' }}>
                                <ArrowDown size={28} className="animate-bounce" />
                            </div>
                            )}
                        </div>
                    </div>

                    {/* ä¸­é–“ï¼šç¶²éš›ç¶²è·¯ (Internet) */}
                    <div className={`flex flex-col justify-center items-center relative py-8 px-2 transition-all duration-700 ease-in-out h-full
                        ${(stage === 'ssl_handshake' || stage === 'tcp_handshake') ? 'md:col-span-4' : 'md:col-span-2'}`}>
                        <div className="absolute inset-y-0 w-0.5 bg-slate-200 left-1/2 -z-10"></div>
                        
                        {/* === æ¡æ‰‹è¦–è¦ºåŒ–å±¤ (Overlay) === */}
                        {renderVisualOverlay()}

                        {/* å‚³è¼¸å‹•ç•«å€ (éæ¡æ‰‹éšæ®µé¡¯ç¤º) */}
                        {stage !== 'ssl_handshake' && stage !== 'tcp_handshake' && (
                            <div className="w-full h-32 relative flex items-center justify-center">
                                {/* å‚³è¼¸ç·šè·¯ */}
                                <div className="w-full h-1 bg-slate-300 absolute rounded-full"></div>
                                
                                {/* å‚³è¼¸ä¸­çš„å°åŒ… */}
                                {stage === 'transmission' && (
                                <div className="absolute z-20 flex flex-col items-center">
                                    <div className="bg-blue-600 text-white p-2 rounded-lg shadow-lg mb-2">
                                    {useSSL ? <Lock size={24} /> : <Unlock size={24} />}
                                    </div>
                                    <div className="text-xs font-bold text-slate-500 bg-white px-2 py-1 rounded shadow-sm border">
                                    å‚³è¼¸ä¸­...
                                    </div>
                                </div>
                                )}
                            </div>
                        )}
                        
                        <div className="text-center bg-slate-50 px-3 py-1 rounded-full border border-slate-200 z-10 mt-auto">
                            <div className="text-xs font-bold text-slate-400 uppercase tracking-widest">Internet</div>
                        </div>
                    </div>

                    {/* å³å´ï¼šæ¥æ”¶ç«¯ (Receiver) */}
                    <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-2 relative overflow-hidden transition-all duration-700 ease-in-out flex flex-col
                        ${(stage === 'ssl_handshake' || stage === 'tcp_handshake') ? 'md:col-span-3' : 'md:col-span-4'}`}>
                         {/* Session Key Indicator (Receiver) */}
                         {useSSL && stage !== 'idle' && stage !== 'handshake' && stage !== 'ssl_handshake' && stage !== 'tcp_handshake' && (
                            <div className="absolute top-2 left-2 bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1 border border-yellow-300 z-20">
                                <Key size={12} /> å°ç¨±é‡‘é‘°å·²å°±ç·’
                            </div>
                        )}

                        <div className="flex items-center gap-2 mb-2 pb-2 border-b border-slate-100 justify-end h-10 shrink-0">
                            <h2 className="font-bold text-lg">æ¥æ”¶ç«¯ (æ‹†è§£)</h2>
                            <Server className="text-green-600" />
                        </div>
                        
                        <div className="flex-1 grid grid-rows-5 relative">
                            {layers.map((layer) => {
                                const isActive = isLayerActive(layer.id);
                                const isDimmed = isLayerDimmed(layer.id);

                                return (
                                <div 
                                    key={`receiver-${layer.id}`}
                                    className={`p-1 rounded-lg border transition-all duration-300 flex justify-between items-center flex-row-reverse text-right
                                    ${layer.color} /* Always apply base color */
                                    ${isActive ? 'border-2 !border-slate-800 shadow-lg scale-[1.02] z-10' : 'border-opacity-50'}
                                    ${isDimmed ? 'opacity-20 grayscale' : ''}`}
                                >
                                    <div className="w-1/3">
                                        <div className="font-bold text-sm text-slate-700 truncate">{layer.name}</div>
                                        <div className="text-[10px] text-slate-500 leading-tight truncate">{layer.desc}</div>
                                    </div>

                                    {/* Active Badge - Moved INSIDE top left corner */}
                                    {isActive && (stage === 'tcp_handshake' || stage === 'ssl_handshake') && (
                                        <div className="absolute left-2 top-1 bg-yellow-500 text-white text-[10px] px-2 py-0.5 rounded-full shadow-sm flex items-center gap-1 z-20 animate-pulse">
                                            <Activity size={10} /> äº’å‹•ä¸­
                                        </div>
                                    )}

                                    {/* å°åŒ…å±•ç¤ºå€ */}
                                    <div className="flex-1 flex justify-start h-8">
                                    {showReceiverPacket(layer.id) && (
                                        <div className="animate-fade-in-right">
                                        {renderPacket(layer.id, false)}
                                        </div>
                                    )}
                                    </div>
                                </div>
                            )})}

                            {/* å‹•æ…‹ç®­é ­ - ä½¿ç”¨ç™¾åˆ†æ¯”å®šä½ */}
                            {stage === 'decapsulation' && (
                            <div className="absolute right-6 text-green-500 z-10 transition-all duration-300" 
                                style={{ top: `${currentLayer * 20 + 10}%`, transform: 'translateY(-50%)' }}>
                                <ArrowUp size={28} className="animate-bounce" />
                            </div>
                            )}
                        </div>
                    </div>
                </div>

                {/* åº•éƒ¨ï¼šæ—¥èªŒå€ï¼šæ”¾å¯¬åˆ° 7xl */}
                <div className="max-w-[90%] md:max-w-7xl mx-auto bg-slate-900 text-slate-300 p-2 rounded-xl shadow-inner font-mono text-sm h-28 overflow-y-auto border border-slate-700">
                    <div className="mb-2 text-slate-500 text-xs uppercase tracking-wider sticky top-0 bg-slate-900 pb-2 border-b border-slate-800 flex justify-between">
                    <span>System Log</span>
                    <span className={stage === 'tcp_handshake' ? 'text-blue-400 font-bold' : stage === 'ssl_handshake' ? 'text-purple-400 font-bold' : 'text-slate-400'}>
                        Status: {stage === 'tcp_handshake' ? `TCP HANDSHAKE (${tcpStep}/3)` : stage === 'ssl_handshake' ? `SSL HANDSHAKE (${handshakeStep}/5)` : stage.toUpperCase()}
                    </span>
                    </div>
                    {logMessages.length === 0 ? (
                    <div className="text-slate-600 italic">è«‹é»æ“Šã€Œè‡ªå‹•æ’­æ”¾ã€æˆ–ã€Œé€æ­¥åŸ·è¡Œã€é–‹å§‹...</div>
                    ) : (
                    logMessages.map((log, idx) => (
                        <div key={idx} className="mb-1 animate-fade-in">
                        <span className="text-slate-500 mr-2">[{log.time}]</span>
                        <span className={
                            log.text.includes('TCP') ? 'text-blue-300' :
                            log.text.includes('SSL') ? 'text-purple-300' :
                            log.text.includes('Handshake') ? 'text-purple-300' :
                            log.text.includes('ç™¼é€ç«¯') ? 'text-blue-400' : 
                            log.text.includes('æ¥æ”¶ç«¯') ? 'text-green-400' : 
                            log.text.includes('æ‡‰ç”¨å±¤') ? 'text-yellow-400' :
                            'text-slate-300'
                        }>
                            {log.text}
                        </span>
                        </div>
                    ))
                    )}
                    {/* è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨çš„ dummy element */}
                    <div ref={(el) => el && el.scrollIntoView({ behavior: "smooth" })}></div>
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TCPIPModel />);
    </script>
</body>
</html>